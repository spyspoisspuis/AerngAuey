name : -DB-  DB
on:
  workflow_dispatch

jobs:
    deploy-db: 
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
     
            - name: Set up SSH
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.LINUX_PRIVATE_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_rsa
                chmod 700 ~/.ssh
                chmod 600 ~/.ssh/id_rsa
                ssh-keyscan -t rsa ${{ secrets.LINUX_HOST }} >> ~/.ssh/known_hosts
            
            - name: Remove directory on server
              run: |
                ssh -i ~/.ssh/id_rsa ${{ secrets.LINUX_USERNAME }}@${{ secrets.LINUX_HOST }} "rm -rf ~/aerngauey/db"                        
            
            - name: Copy db directory to server
              run: |
                scp -r -i ~/.ssh/id_rsa ./db ${{ secrets.LINUX_USERNAME }}@${{ secrets.LINUX_HOST }}:~/aerngauey

            - name: Deploy to Ubuntu server
              uses: appleboy/ssh-action@master
              with:
                host: ${{secrets.LINUX_HOST}}
                username: ${{secrets.LINUX_USERNAME}}
                key: ${{ secrets.LINUX_PRIVATE_KEY }}
                script: |
                  cd aerngauey
                  docker stop postgres-container || true
                  docker rm  postgres-container || true
                  docker compose -f docker-compose.prod.yml up --build -d db
